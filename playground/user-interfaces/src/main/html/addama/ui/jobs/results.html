<html>
<head>
    <title>Job Results</title>

    <link rel="stylesheet" type="text/css" href="/addama/ui/ext-js-3.2.1/resources/css/ext-all.css">
    <link rel="stylesheet" type="text/css" href="/addama/ui/ext-js-3.2.1/examples/shared/examples.css"/>
    <script type="text/javascript" src="/addama/ui/ext-js-3.2.1/adapter/ext/ext-base.js"></script>
    <script type="text/javascript" src="/addama/ui/ext-js-3.2.1/ext-all.js"></script>
    <script type="text/javascript" src="/js/topbar.js"></script>

    <script type="text/javascript">
        
        function loadTopBar() {
            new TopBar().initialize("container_topbar");
        }

        function loadUi() {
            var northPanel = {
                id: "north-panel",
                region: "north",
                height: 30,
                contentEl: "container_topbar",
                frame: true,
                autoHeight: true,
                margins: "5 5 5 5"
            };

            var westPanel = {
                id: "west-panel",
                region: "west",
                width: 250,
                title: "Jobs",
                contentEl: "container_jobs",
                margins: "5 5 5 5",
                autoScroll: true,
                frame: true
            };

            var centerPanel = {
                id: "center-panel",
                region: "center",
                width: 400,
                layout: {
                    type: "vbox",
                    pack: "start",
                    align: "stretch"
                },
                defaults: {
                    frame: true, height: 220, margins: "5 5 5 5", autoScroll: true
                },
                items: [
                    {
                        title: "Welcome",
                        contentEl: "container_welcome"
                    },                        
                    {
                        title: "Results",
                        contentEl: "container_results"
                    }
                ]
            };

            var southPanel = {
                id: "south-panel",
                region: "south",
                height: 150,
                minSize: 75,
                maxSize: 250,                
                frame: true,
                margins: "5 5 5 5",
                title: "Messages",
                autoScroll: true,
                contentEl: "container_messages"
            };

            new Ext.Viewport({
                layout: "border",
                title: "Addama Job Results",
                hideBorders: true,
                items: [ northPanel, westPanel, centerPanel, southPanel ],
                renderTo: Ext.getBody()
            });
        }

        function loadJob() {
            Ext.get("container_job").dom.innerHTML = "No Job Selected";
            Ext.get("container_jobs").dom.innerHTML = "";
            Ext.get("container_results").dom.innerHTML = "";
            Ext.get("container_status").dom.innerHTML = "";

            var jobUri = getJobUri();
            if (!jobUri) {
                return;
            }

            Ext.get("container_job").dom.innerHTML = "Loading Job " + jobUri;

            doGet(jobUri, function(json) {
                var container_job_text=  "Displaying Job Uri:" + json.uri;
                if(json.label != null){
                    container_job_text = container_job_text + "<br/>Job Label:" + json.label;
                }
                Ext.get("container_job").dom.innerHTML = container_job_text;
                Ext.get("container_status").dom.innerHTML = "Status is " + json.status;
            });
            
            doGet(jobUri + "/outputs", function(json) {
                if (json.items) {                   
                    var spec = { id: 'outputs-ul', tag: 'ul', cls: 'my-list', children: [] };
                    for (var i = 0; i < json.items.length; i++) {
                        var item = json.items[i];
                        var html = "<a href='" + item.uri + "' target='_blank'>" + item.name + "</a>";
                        spec.children[spec.children.length] = { tag: "li", id: "item" + i, html: html };
                    }
                    Ext.DomHelper.append("container_results", spec);
                }
            });

            var jobsUri = jobUri.substring(0, jobUri.lastIndexOf("/"));
            doGet(jobsUri, function(json) {
                if (json.items) {
                    var spec = { id: 'jobs-ul', tag: 'ul', cls: 'my-list', children: [] };
                    for (var i = 0; i < json.items.length; i++) {
                        var item = json.items[i];
                        var html = "<a href='" + getNewJobLocation(item.uri) + "'>" + getJobName(item) + "</a>";
                        spec.children[spec.children.length] = { tag: "li", id: "item" + i, html: html };
                    }
                    Ext.DomHelper.append("container_jobs", spec);
                }
            });
        }

        function getJobName(job) {
            if(job.label == null){
                return job.uri.substring(job.uri.lastIndexOf("/") + 1, job.uri.length);
            }
            else{
                return job.label;
            }
        }

        function getNewJobLocation(jobUri) {
            var docloc = document.location.href;
            if (docloc.indexOf("?") > 0) {
                docloc = docloc.substring(docloc, docloc.indexOf("?"));
            }
            return docloc + "?job=" + jobUri;
        }
        
        function getJobUri() {
            var hu = window.location.search.substring(1);
            var gy = hu.split("&");
            for (var i = 0; i < gy.length; i++) {
                var ft = gy[i].split("=");
                if (ft[0] == "job") {
                    return ft[1];
                }
            }
            return null;
        }

        function loadLog() {
            var uri = getJobUri() + "/log";
            Ext.Ajax.request({
                url: uri,
                method: "GET",
                success: function(o) {
                    var txt = o.responseText;
                    while (txt.indexOf("\n") > 0) {
                        txt = txt.replace("\n", "<br/>");
                    }
                    Ext.get("container_messages").dom.innerHTML = txt;
                },
                failure: function(o) {
                    Ext.get("container_messages").dom.innerHTML = o.responseText;
                }
            });
        }
        
        function doGet(uri, jsonCallback) {
            Ext.Ajax.request({
                url: uri,
                method: "GET",
                success: function(o) {
                    var json = Ext.util.JSON.decode(o.responseText);
                    if (json) {
                        jsonCallback(json);
                    }
                },
                failure: function(o) {
                    Ext.get("container_messages").dom.innerHTML = o.responseText;
                }
            });
        }

        Ext.onReady(loadTopBar);
        Ext.onReady(loadUi);
        Ext.onReady(loadJob);
    </script>
</head>
<body>
    <div id="container_topbar"></div>
    <div id="container_welcome">
        <h3>Job Results Page</h3>
        <span>This page displays results of jobs executed through Addama</span>
        <a href="/">Back to Main Page</a>
        <button onclick="loadJob()">Refresh</button>
        <button onclick="loadLog()">Show Log</button>
        <hr/>
        <span id="container_job"></span><br/><span id="container_status"></span>
    </div>
    <div id="container_jobs">
    </div>
    <div id="container_results">
    </div>
    <div id="container_messages">
    </div>
</body>
</html>
