<html>
<head>
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
    <title>Greenlist</title>
    <link rel="stylesheet" type="text/css" href="https://informatics-apps.systemsbiology.net/ext-js-3.3.1/resources/css/ext-all.css">
    <link rel="stylesheet" type="text/css" href="https://informatics-apps.systemsbiology.net/ext-js-3.3.1/examples/shared/examples.css"/>
    <script type="text/javascript" src="https://informatics-apps.systemsbiology.net/ext-js-3.3.1/adapter/ext/ext-base.js"></script>
    <script type="text/javascript" src="https://informatics-apps.systemsbiology.net/ext-js-3.3.1/ext-all.js"></script>

    <script type="text/javascript">
        var userWindow;
        var fpAddUser;
        var greenlistStore = new Ext.data.ArrayStore({
            fields: [ {name: "id"}, {name: "uri"} ]
        });

        Ext.onReady(function() {
            var grid = new Ext.grid.GridPanel({
                store: greenlistStore,
                title: "Members",
                tbar: [
                    new Ext.Button(new Ext.Action({ text: "Add User", handler: addNewUser }))
                ],
                columns: [
                    { header: "User", width: 300, sortable: true, dataIndex: "id" },
                    { header: "Uri", width: 300, sortable: true, dataIndex: "uri", hidden: true }
                ],
                stripeRows: true,
                autoHeight: true,
                width: 600,
                style: "padding:10px;"
            });
            grid.render("container_existing_greenlist");

            var panel = new Ext.Panel({
                width: 620,
                height: 700,
                title: "Greenlist",
                bodyStyle: "padding:10px;",
                autoScroll: true,
                defaults: { frame: true, autoScroll: true, style: "padding:10px;"},
                items: [
                    grid
                ],
                renderTo: Ext.getBody()
            });

            loadGreenlist();
        });

        function loadGreenlist() {
            Ext.MessageBox.show({
                msg: "Loading, please wait...",
                progressText: "Loading...",
                width:300,
                wait:true,
                waitConfig: {interval:200}
            });

            Ext.Ajax.request({
                url: "/addama/greenlist",
                method: "GET",
                success: function(o) {
                    var json = Ext.util.JSON.decode(o.responseText);
                    if (json && json.items) {
                        var data = [];
                        Ext.each(json.items, function(item) {
                            data.push([item.id,item.uri]);
                        });
                        greenlistStore.loadData(data);
                        Ext.MessageBox.hide();
                    }
                },
                failure: handleFailure
            });
        }

        function addNewUser() {
            fpAddUser = new Ext.FormPanel({
                width: 400,
                frame: true,
                autoHeight: true,
                bodyStyle: 'padding: 10px 10px 0 10px;',
                method: 'POST',
                standardSubmit: true,
                items: [
                    { xtype: 'textfield', fieldLabel: "User Email", name: "label", allowBlank:false, id:"emailLabel" }
                ],
                buttons: [
                    {
                        text: 'Submit',
                        handler: function() {
                            if (fpAddUser.getForm().isValid()) {
                                Ext.Ajax.request({
                                    url: "/addama/greenlist/" + Ext.getDom("emailLabel").value,
                                    method: "POST",
                                    success: function(o) {
                                        userWindow.close();
                                        loadGreenList();
                                    },
                                    failure: handleFailure
                                });
                            }
                        }
                    }
                ]
            });

            userWindow = new Ext.Window({
                width:400, autoHeight:true, title: 'Add New User', items: fpAddUser, frame: true
            }).show();
        }

        function handleFailure(o, e) {
            Ext.MessageBox.show({
                title: "Errors Submitting Request",
                msg: o + "<br/>" + e,
                buttons: Ext.MessageBox.OK,
                icon: Ext.MessageBox.ERROR
            });
        }
    </script>
</head>
<body>
<div id="c_banner"><a href="http://addama.org" target="_blank"><img src="/images/banner.png" alt="Addama"/></a></div>
<div id="container_toolbar"></div>
<div id="container_existing_greenlist"></div>
</body>
</html>